<%= form_with model: @log,
              html: { class: "log-form js-log-form",
                      data: { existing_images_count: @log.images.size } } do |f| %>

  <% if @log.errors.any? %>
    <div class="errors card">
      <p><%= pluralize(@log.errors.count, "件") %>のエラーがあります。</p>
      <ul>
        <% @log.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="field">
    <%= f.label :title, "タイトル" %>
    <%= f.text_field :title, required: true %>
  </div>

  <div class="field">
    <%= f.label :category_id, "カテゴリ" %>
    <%= f.collection_select :category_id,
          current_user.categories.order(:name), :id, :name,
          { include_blank: "未設定" } %>
  </div>

  <div class="field">
    <%= label_tag :tag_names, "タグ（カンマ区切り）" %>
    <%= text_field_tag :tag_names,
          @log.tags&.map(&:name)&.join(", "),
          placeholder: "例）Rails, ActiveRecord, VLOOKUP" %>
    <p class="hint">既存タグ候補は一覧画面のタグフィルタでサジェスト。</p>
  </div>

  <div class="field">
    <%= f.label :body, "説明" %>
    <%= f.rich_text_area :body, placeholder: "ここに説明を書くことができます…" %>

  </div>

  <div class="field">
    <%= f.label :code, "コード例" %>
    <%= f.text_area :code, rows: 10 %>
  </div>

  <div class="field">
    <%= f.label :images, "画像（0〜5枚）" %>
    <%= f.file_field :images, multiple: true, accept: "image/*" %>
    <p class="hint paste-hint">
      ファイル選択のほか、フォーム上で Ctrl+V するとスクリーンショットを画像として追加できます。
    </p>

    <% if @log.persisted? && @log.images.attached? %>
      <div class="image-strip">
        <% @log.images.each do |img| %>
          <div class="image-item">
            <%= image_tag img.variant(resize_to_limit: [160, 120]), class: "log-image-thumb" %>
            <label class="hint">
              <%= check_box_tag "log[remove_image_ids][]", img.id %>
              この画像を削除
            </label>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <div class="field">
    <%= f.label :memo, "ひとことメモ" %>
    <%= f.rich_text_area :memo, placeholder: "ひとことメモを入力…" %>
  </div>

  <div class="actions">
    <%= f.submit class: "btn-accent" %>
    <%= link_to "キャンセル", logs_path, class: "btn-subtle" %>
  </div>
<% end %>
