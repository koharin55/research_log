<!-- app/views/categories/index.html.erb -->

<div class="rs-page-container">
  <div class="rs-page-card">

    <header class="rs-page-header">
      <h1 class="rs-page-title">カテゴリ管理</h1>
      <p class="rs-page-subtitle">
        学習ログで使用するカテゴリを追加・編集・削除できます。
      </p>
    </header>

    <div class="categories-layout" data-controller="category-inline-edit">
      <!-- 左側：新規追加フォーム -->
      <section class="categories-new">
        <h2 class="section-title">新しいカテゴリを追加</h2>

        <%= form_with model: @category,
                      url: categories_path,
                      local: true,
                      class: "categories-form" do |f| %>

          <% if @category.errors.any? %>
            <div class="rs-form-errors">
              <p class="rs-form-errors__title">
                <%= pluralize(@category.errors.count, "件のエラー") %>があります：
              </p>
              <ul>
                <% @category.errors.full_messages.each do |msg| %>
                  <li><%= msg %></li>
                <% end %>
              </ul>
            </div>
          <% end %>

          <div class="rs-form-group">
            <label class="rs-form-label" for="category_name">カテゴリ名</label>
            <%= f.text_field :name,
                  required: true,
                  placeholder: "例）Rails, Excel VBA, M言語",
                  class: "rs-input-text" %>
          </div>

          <div class="rs-form-actions">
            <%= f.submit "追加", class: "rs-button-primary" %>
            <%= link_to "ログ一覧に戻る", logs_path, class: "rs-button-ghost" %>
          </div>
        <% end %>

        <section class="categories-edit-panel is-hidden" data-category-inline-edit-target="panel">
          <h3 class="section-title">カテゴリを編集</h3>
          <p class="categories-edit-caption" data-category-inline-edit-target="caption">
            編集したいカテゴリの「編集」をクリックしてください。
          </p>

          <%= form_with model: @category,
                        url: "#",
                        method: :patch,
                        local: true,
                        html: { data: { category_inline_edit_target: "form" }, class: "categories-form" } do |f| %>
            <div class="rs-form-group">
              <label class="rs-form-label" for="category_edit_name">カテゴリ名</label>
              <%= f.text_field :name,
                    required: true,
                    placeholder: "カテゴリ名を入力",
                    class: "rs-input-text",
                    id: "category_edit_name",
                    data: { category_inline_edit_target: "input" } %>
            </div>

            <div class="rs-form-actions">
              <%= f.submit "更新", class: "rs-button-primary" %>
              <button type="button"
                      class="rs-button-ghost"
                      data-action="category-inline-edit#cancel">
                キャンセル
              </button>
            </div>
          <% end %>
        </section>
      </section>

      <!-- 右側：登録済みカテゴリ一覧 -->
      <section class="categories-list">
        <h2 class="section-title">登録済みカテゴリ</h2>

        <% if @categories.empty? %>
          <div class="rs-empty-state">
            <p class="rs-empty-state__title">まだカテゴリがありません。</p>
            <p class="rs-empty-state__body">
              最初のカテゴリとして「Ruby」「Excel VBA」などを作成してみましょう。
            </p>
          </div>
        <% else %>
          <table class="category-table">
            <thead>
              <tr>
                <th>名前</th>
                <th style="width: 150px;"></th>
              </tr>
            </thead>
            <tbody>
              <% @categories.each do |category| %>
                <tr>
                  <td><%= category.name %></td>
                  <td class="category-table__actions">
                    <%= link_to "編集",
                          edit_category_path(category),
                          class: "rs-table-link",
                          data: {
                            action: "category-inline-edit#start",
                            category_inline_edit_url_param: category_path(category),
                            category_inline_edit_name_param: category.name
                          } %>
                    <%= link_to "削除",
                          category_path(category),
                          data: {
                            turbo_method: :delete,
                            turbo_confirm: "カテゴリ「#{category.name}」を削除しますか？（関連ログのカテゴリは未設定になります）"
                          },
                          class: "rs-table-link rs-table-link--danger" %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% end %>
      </section>
    </div>
  </div>
</div>
